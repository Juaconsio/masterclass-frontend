---
import Navbar from './Navbar.astro';
import Hero from './Hero.astro';
import CourseCard from './courses/CourseCard.astro';
import ReviewsCarousel from './reviews/ReviewsCarousel.tsx';
import { Icon } from 'astro-icon/components';
import { getCollection } from 'astro:content';
import { Carousel } from '@components/UI';
import Stats from './stats.astro';
import ContactUs from './contactUs/index.astro';
import Footer from './footer.astro';
// Get collections
const allCourses = await getCollection('courses');
const allReviews = await getCollection('reviews');

// Get featured courses (filter by featured flag, then fallback to first 4)
const featuredCourses = allCourses.filter((course) => course.data.featured);
// If no featured courses or less than 4, get the first 4 courses
const coursesToShow =
  featuredCourses.length >= 4 ? featuredCourses.slice(0, 4) : allCourses.slice(0, 4);

// Get featured reviews (filter by featured flag, then fallback to first 6)
const featuredReviewsFiltered = allReviews.filter((review) => review.data.featured);
const reviewsToShow =
  featuredReviewsFiltered.length >= 6
    ? featuredReviewsFiltered.slice(0, 6)
    : allReviews.slice(0, 6);

// Convert reviews to plain objects for React component
const reviewsData = reviewsToShow.map((review) => ({
  id: review.data.id,
  name: review.data.name,
  profile: review.data.profile,
  studies: review.data.studies,
  comment: review.data.comment,
  course: review.data.course,
  rating: review.data.rating,
  image: review.data.image,
  date: review.data.date,
}));

const main = [
  {
    title: 'Clases de excelencia para salvar ramos',
    icon: 'mdi:target-arrow',
    desc: 'Los mejores tips y técnicas para que rendir en tus evaluaciones',
  },
  {
    title: 'Sesiones en vivo ',
    icon: 'mdi:account-voice',
    desc: 'Aquí aprenderás en tiempo real con resolución de dudas al instante',
  },
  {
    title: 'Recursos y materiales exclusivos',
    icon: 'mdi:book-open-page-variant',
    desc: 'Creados por el equipo para afrontar las evaluaciones más difíciles',
  },
  {
    title: 'Una comunidad que te acompaña',
    icon: 'mdi:account-group',
    desc: 'Compartimos el mismo objetivo y nos apoyamos para lograrlo',
  },
];

const getUsalAnimation = (idx: number) => {
  switch (idx % 4) {
    case 0:
      return 'fade-r delay-100';
    case 1:
      return 'fade-r delay-300';
    case 2:
      return 'fade-r delay-500';
    case 3:
      return 'fade-r delay-700';
    default:
      return 'fade-u';
  }
};
---

<div>
  <Navbar />

  <!-- Hero Section -->
  <Hero />

  <Stats />

  <!-- Featured Courses Section -->
  <section id="courses" class="py-12 lg:h-hero">
    <div class="container mx-auto px-4">
      <div class="text-center mb-12 lg:mb-16">
        <h2 class="text-3xl sm:text-4xl lg:text-5xl font-bold mb-4 lg:mb-6">Revisa los cursos que enseñamos</h2>
        <p class="text-lg sm:text-xl text-base-content/70 max-w-3xl mx-auto">
          ¿No encuentras el que buscas? Contáctanos y veremos si podemos crearlo para ti.
        </p>
      </div>

      <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-6 lg:gap-8 mb-8 lg:mb-12">
        {coursesToShow.map((course, index) => <CourseCard course={course} index={index} />)}
      </div>

      <div class="text-center">
        <a href="/courses" class="btn btn-primary btn-md lg:btn-lg"> Ver Todos los Cursos </a>
      </div>
    </div>
  </section>

  <!-- About Us Section -->
  <section id="about" class="py-20 h-hero">
    <div class="flex flex-col mx-auto px-4 max-w-7xl gap-10">
      <div class="px-4 text-center mb-4 flex gap-4 flex-col justify-center">
        <h2 class="text-4xl md:text-5xl font-bold">
          Más que una plataforma de cursos en línea.
          <Icon name="mdi:handshake" class="inline text-primary" />
        </h2>
        <p class="text-xl text-base-content/70 leading-relaxed">
          Clases hechas pa’ remontar, materiales que te salvan y un equipo que te banca.
        </p>
      </div>

      <div class="grid lg:grid-cols-2 gap-16 items-center">
        <div class="flex flex-col justify-between h-full">
          <h3 class="text-base-content/50 pb-2">Somos...</h3>
          <div class="flex flex-col justify-between h-full">
            {
              main.map((item, index) => (
                <div class="flex items-start gap-4" data-usal={getUsalAnimation(index)}>
                  <div class="flex justify-center items-center bg-primary text-primary-content rounded-xl p-4">
                    <Icon name={item.icon} size={32} />
                  </div>
                  <div>
                    <h3 class="text-2xl mb-2">{item.title}</h3>
                    <p class="text-base-content/50">{item.desc}</p>
                  </div>
                </div>
              ))
            }
          </div>
        </div>

        <div class="flex justify-center">
          <Carousel client:load />
        </div>
      </div>
    </div>
  </section>

  <!-- Reviews Section -->
  <div class="bg-base-200">
    <section id="reviews" class="py-12 lg:pt-20 lg:pb-20">
      <div class="container mx-auto px-4">
        <div class="text-center mb-12 lg:mb-16">
          <h2 class="text-3xl sm:text-4xl lg:text-5xl font-bold mb-4 lg:mb-6">Que te lo cuenten ellas y ellos</h2>
          <p class="text-lg sm:text-xl text-base-content/70 max-w-3xl mx-auto">
            Conoce la experiencia de quienes ya han confiado en nosotros.
          </p>
        </div>

        <ReviewsCarousel reviews={reviewsData} client:load />
      </div>
    </section>
  </div>

  <!-- Contact Section -->
  <ContactUs />

  <Footer />
</div>
