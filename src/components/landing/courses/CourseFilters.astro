---
import type { CourseListingEntry, Department, Level } from '../../../types/course';

interface Props {
  departments: Department[];
  levels: Level[];
  courses: CourseListingEntry[];
  idPrefix?: string;
}

const { departments, levels, courses, idPrefix = '' } = Astro.props;
---

<div class="card shadow-lg mb-6 sm:mb-8 lg:mb-0">
  <div class="card-body p-4 sm:p-6">
    <div class="flex flex-col gap-3 sm:gap-4">
      <!-- Search Input -->
      <div class="flex flex-col gap-2">
        <h3 class="text-lg font-bold">Filtros</h3>
        <div class="form-control w-full">
          <div class="input-group flex">
            <input
              type="text"
              placeholder="Buscar por nombre, sigla..."
              class="input input-bordered input-sm sm:input-md flex-1 min-w-0 text-sm sm:text-base"
              id={`${idPrefix}search-input`}
            />
            <button
              class="btn btn-square btn-sm sm:btn-md btn-primary"
              id={`${idPrefix}search-btn`}
              type="button"
            >
              <svg
                class="w-4 h-4 sm:w-5 sm:h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="m21 21-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
              </svg>
            </button>
          </div>
        </div>

        <!-- Filter Dropdowns -->
        <div class="form-control w-full">
          <select
            class="select select-bordered select-sm sm:select-md text-sm sm:text-base w-full"
            id={`${idPrefix}department-filter`}
          >
            <option value="">Todos los Departamentos</option>
            {departments.map((department) => <option value={department}>{department}</option>)}
          </select>
        </div>

        <div class="form-control w-full">
          <select
            class="select select-bordered select-sm sm:select-md text-sm sm:text-base w-full"
            id={`${idPrefix}level-filter`}
          >
            <option value="">Todos los Niveles</option>
            {levels.map((level) => <option value={level}>{level}</option>)}
          </select>
        </div>

        <div class="flex flex-wrap items-center justify-between gap-2">
          <div class="form-control flex items-center">
            <label class="label cursor-pointer gap-2 py-1 sm:py-2">
              <span class="label-text text-xs sm:text-sm whitespace-nowrap">Solo destacados</span>
              <input
                type="checkbox"
                class="toggle toggle-primary toggle-xs sm:toggle-sm"
                id={`${idPrefix}featured-toggle`}
              />
            </label>
          </div>
          <button
            class="btn btn-ghost btn-xs sm:btn-sm"
            id={`${idPrefix}clear-filters`}
            type="button"
          >
            <svg
              class="w-3 h-3 sm:w-4 sm:h-4 mr-1"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"></path>
            </svg>
            <span class="hidden sm:inline">Limpiar</span>
          </button>
        </div>

        <div class="form-control hidden">
          <select class="select select-bordered select-sm w-full" id={`${idPrefix}price-filter`}>
            <option value="">Cualquier precio</option>
            <option value="0-20000">$0 - $20.000</option>
            <option value="20000-40000">$20.000 - $40.000</option>
            <option value="40000-60000">$40.000 - $60.000</option>
            <option value="60000+">$60.000+</option>
          </select>
        </div>
      </div>

      <!-- Active Filters Display -->
      <div
        id={`${idPrefix}active-filters`}
        class="hidden mt-3 sm:mt-4 pt-3 sm:pt-4 border-t border-base-300"
      >
        <div class="flex items-center gap-2 text-xs sm:text-sm flex-wrap">
          <span class="text-base-content/70">Filtros activos:</span>
          <div id={`${idPrefix}filter-tags`} class="flex flex-wrap gap-1.5 sm:gap-2"></div>
        </div>
      </div>

      <!-- Results Count and Sort -->
      <div
        class="flex flex-col gap-2 mt-3 sm:mt-4 pt-3 sm:pt-4 border-t border-base-300 text-xs sm:text-sm text-base-content/70"
      >
        <span id={`${idPrefix}results-count`}>Mostrando todos los {courses.length} cursos</span>
        <div class="form-control">
          <select class="select select-bordered select-xs w-full" id={`${idPrefix}sort-select`}>
            <option value="default">Ordenar por defecto</option>
            <option value="name-asc">Nombre A-Z</option>
            <option value="name-desc">Nombre Z-A</option>
            <option value="price-asc">Precio menor a mayor</option>
            <option value="price-desc">Precio mayor a menor</option>
            <option value="department">Por departamento</option>
            <option value="level">Por nivel</option>
          </select>
        </div>
      </div>
    </div>
  </div>

<script define:vars={{ idPrefix }}>
  const prefix = typeof idPrefix === 'string' ? idPrefix : '';

  class CourseFilters {
    constructor() {
      this.initializeElements();
      this.attachEventListeners();
      this.updateResultsCount(-1);
    }

    initializeElements() {
      this.searchInput = document.querySelector(`#${prefix}search-input`);
      this.departmentFilter = document.querySelector(`#${prefix}department-filter`);
      this.levelFilter = document.querySelector(`#${prefix}level-filter`);
      this.featuredToggle = document.querySelector(`#${prefix}featured-toggle`);
      this.priceFilter = document.querySelector(`#${prefix}price-filter`);
      this.sortSelect = document.querySelector(`#${prefix}sort-select`);
      this.clearButton = document.querySelector(`#${prefix}clear-filters`);
      this.activeFiltersContainer = document.querySelector(`#${prefix}active-filters`);
      this.filterTagsContainer = document.querySelector(`#${prefix}filter-tags`);
      this.resultsCount = document.querySelector(`#${prefix}results-count`);
      this.courseCards = document.querySelectorAll('.course-card');
      this.emptyState = document.querySelector('#empty-state');
      this.courseGrid = document.querySelector('#course-grid');
    }

    attachEventListeners() {
      let searchTimeout;
      this.searchInput?.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => this.applyFilters(), 300);
      });

      [this.departmentFilter, this.levelFilter, this.priceFilter, this.sortSelect].forEach(
        (filter) => filter?.addEventListener('change', () => this.applyFilters())
      );

      this.featuredToggle?.addEventListener('change', () => this.applyFilters());
      this.clearButton?.addEventListener('click', () => this.clearAllFilters());

      const emptyClearButton = document.querySelector('#empty-state #clear-filters');
      if (emptyClearButton) {
        emptyClearButton.addEventListener('click', () => this.clearAllFilters());
      }
    }

    getCurrentFilters() {
      return {
        search: this.searchInput?.value?.toLowerCase().trim() ?? '',
        department: this.departmentFilter?.value ?? '',
        level: this.levelFilter?.value ?? '',
        featured: this.featuredToggle?.checked ?? false,
        priceRange: this.priceFilter?.value ?? '',
        sort: this.sortSelect?.value ?? 'default',
      };
    }

    matchesPriceRange(price, range) {
        if (!range) return true;

        switch (range) {
          case '0-20000':
            return price >= 0 && price <= 20000;
          case '20000-40000':
            return price > 20000 && price <= 40000;
          case '40000-60000':
            return price > 40000 && price <= 60000;
          case '60000+':
            return price > 60000;
          default:
            return true;
        }
      }

    applyFilters() {
      const filters = this.getCurrentFilters();
      const visibleCards = [];

      this.courseCards?.forEach((card) => {
        const cardDepartment = card.dataset.department || '';
        const cardLevel = card.dataset.level || '';
        const cardAcronym = card.dataset.acronym || '';
        const titleElement = card.querySelector('.card-title');
        const descriptionElement = card.querySelector('p');
        const cardTitle = (titleElement?.textContent ?? '').toLowerCase();
        const cardDescription = (descriptionElement?.textContent ?? '').toLowerCase();
        const searchableText = `${cardTitle} ${cardDescription} ${cardAcronym.toLowerCase()}`;
        const priceElement = card.querySelector('.text-primary');
        const priceText = priceElement?.textContent?.replace(/[^\d]/g, '') ?? '0';
        const cardPrice = parseInt(priceText, 10) || 0;

          // Check if featured
          const isFeatured = card.querySelector('.badge-warning') !== null;

          // Apply filters
          const matchesSearch = !filters.search || searchableText.includes(filters.search);
          const matchesDepartment = !filters.department || cardDepartment === filters.department;
          const matchesLevel = !filters.level || cardLevel === filters.level;
          const matchesFeatured = !filters.featured || isFeatured;
          const matchesPrice = this.matchesPriceRange(cardPrice, filters.priceRange);

          const isVisible =
            matchesSearch && matchesDepartment && matchesLevel && matchesFeatured && matchesPrice;

          if (isVisible) {
            card.style.display = 'block';
            card.classList.add('animate-fadeIn');
            visibleCards.push(card);
          } else {
            card.style.display = 'none';
            card.classList.remove('animate-fadeIn');
          }
        });

        // Apply sorting to visible cards
        if (filters.sort !== 'default') {
          this.sortCards(visibleCards, filters.sort);
        }

        this.updateUI(filters, visibleCards.length);
      }

    sortCards(cards, sortType) {
      const parent = this.courseGrid;
      cards.sort((a, b) => {
        switch (sortType) {
          case 'name-asc':
            return (a.querySelector('.card-title')?.textContent || '').localeCompare(
              b.querySelector('.card-title')?.textContent || '',
              'es'
            );
          case 'name-desc':
            return (b.querySelector('.card-title')?.textContent || '').localeCompare(
              a.querySelector('.card-title')?.textContent || '',
              'es'
            );
          case 'price-asc': {
            const priceA = parseInt(
              a.querySelector('.text-primary')?.textContent?.replace(/[^\d]/g, '') || '0',
              10
            );
            const priceB = parseInt(
              b.querySelector('.text-primary')?.textContent?.replace(/[^\d]/g, '') || '0',
              10
            );
            return priceA - priceB;
          }
          case 'price-desc': {
            const priceDescA = parseInt(
              a.querySelector('.text-primary')?.textContent?.replace(/[^\d]/g, '') || '0',
              10
            );
            const priceDescB = parseInt(
              b.querySelector('.text-primary')?.textContent?.replace(/[^\d]/g, '') || '0',
              10
            );
            return priceDescB - priceDescA;
          }
          case 'department':
            return (a.dataset.department || '').localeCompare(b.dataset.department || '', 'es');
          case 'level':
            return (a.dataset.level || '').localeCompare(b.dataset.level || '', 'es');
          default:
            return 0;
        }
      });
      cards.forEach((card) => parent?.appendChild(card));
    }

    updateUI(filters, visibleCount) {
      this.updateResultsCount(visibleCount);
      if (visibleCount === 0) {
        if (this.courseGrid) this.courseGrid.style.display = 'none';
        if (this.emptyState) this.emptyState.classList.remove('hidden');
      } else {
        if (this.courseGrid) this.courseGrid.style.display = 'grid';
        if (this.emptyState) this.emptyState.classList.add('hidden');
      }
      this.updateActiveFilters(filters);
      const activeCount =
        (filters.search ? 1 : 0) +
        (filters.department ? 1 : 0) +
        (filters.level ? 1 : 0) +
        (filters.featured ? 1 : 0) +
        (filters.priceRange ? 1 : 0);
      const mobileBadge = document.querySelector('#mobile-filters-badge');
      if (mobileBadge) {
        mobileBadge.textContent = String(activeCount);
        mobileBadge.classList.toggle('hidden', activeCount === 0);
      }
    }

    updateResultsCount(count) {
      if (count === -1) {
        count = Array.from(this.courseCards ?? []).filter(
          (card) => card.style.display !== 'none'
        ).length;
      }
      const total = (this.courseCards?.length) ?? 0;
      if (this.resultsCount) {
        this.resultsCount.textContent =
          count === total
            ? `Mostrando todos los ${total} cursos`
            : `Mostrando ${count} de ${total} cursos`;
      }
    }

    updateActiveFilters(filters) {
      const activeFilters = [];
      if (filters.search) activeFilters.push({ label: `BÃºsqueda: "${filters.search}"`, key: 'search' });
      if (filters.department) activeFilters.push({ label: `Departamento: ${filters.department}`, key: 'department' });
      if (filters.level) activeFilters.push({ label: `Nivel: ${filters.level}`, key: 'level' });
      if (filters.featured) activeFilters.push({ label: 'Solo destacados', key: 'featured' });
      if (filters.priceRange) {
        const priceLabels = {
          '0-20000': '$0 - $20.000',
          '20000-40000': '$20.000 - $40.000',
          '40000-60000': '$40.000 - $60.000',
          '60000+': '$60.000+',
        };
        activeFilters.push({
          label: `Precio: ${priceLabels[filters.priceRange] ?? filters.priceRange}`,
          key: 'priceRange',
        });
      }

      if (activeFilters.length > 0) {
        this.activeFiltersContainer?.classList.remove('hidden');
        if (this.filterTagsContainer) {
          this.filterTagsContainer.innerHTML = activeFilters
            .map(
              (filter) => `
            <div class="badge badge-primary gap-2">
              ${filter.label}
              <button class="btn btn-xs btn-circle btn-ghost" data-filter-key="${filter.key}">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>
          `
            )
            .join('');
          this.filterTagsContainer.querySelectorAll('[data-filter-key]').forEach((button) => {
            button.addEventListener('click', (e) => {
              const filterKey = e.currentTarget?.dataset?.filterKey;
              if (filterKey) this.removeFilter(filterKey);
            });
          });
        }
      } else {
        this.activeFiltersContainer?.classList.add('hidden');
      }
    }

    removeFilter(filterKey) {
      switch (filterKey) {
        case 'search':
          if (this.searchInput) this.searchInput.value = '';
          break;
        case 'department':
          if (this.departmentFilter) this.departmentFilter.value = '';
          break;
        case 'level':
          if (this.levelFilter) this.levelFilter.value = '';
          break;
        case 'featured':
          if (this.featuredToggle) this.featuredToggle.checked = false;
          break;
        case 'priceRange':
          if (this.priceFilter) this.priceFilter.value = '';
          break;
      }
      this.applyFilters();
    }

    clearAllFilters() {
      if (this.searchInput) this.searchInput.value = '';
      if (this.departmentFilter) this.departmentFilter.value = '';
      if (this.levelFilter) this.levelFilter.value = '';
      if (this.featuredToggle) this.featuredToggle.checked = false;
      if (this.priceFilter) this.priceFilter.value = '';
      if (this.sortSelect) this.sortSelect.value = 'default';
      this.applyFilters();
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    new CourseFilters();
  });
</script>

  <style>
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .animate-fadeIn {
      animation: fadeIn 0.3s ease-out;
    }
  </style>
</div>
