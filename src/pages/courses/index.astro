---
export const prerender = false;
import Layout from '@layouts/Layout.astro';
import Navbar from '@components/landing/Navbar.astro';
import CourseCard from '@components/landing/courses/CourseCard.astro';
import CourseFilters from '@components/landing/courses/CourseFilters.astro';
import { Icon } from 'astro-icon/components';
import { getPublicCourseCatalog } from '@/lib/courseCatalog';
const courses = await getPublicCourseCatalog();

const departments = [...new Set(courses.map((course) => course.data.department))];
const levels = [...new Set(courses.map((course) => course.data.level))];

// Sort courses: featured first, then by department
const sortedCourses = [...courses].sort((a, b) => {
  if (a.data.featured && !b.data.featured) return -1;
  if (!a.data.featured && b.data.featured) return 1;
  return a.data.department.localeCompare(b.data.department, 'es');
});

const catalogUnavailable = courses.length === 0;
---

<Layout title="Cursos Disponibles - TutorÃ­a Universitaria">
  <Navbar />
  <!-- Hero Section -->
  <div class="container mx-auto mt-16 px-4 py-12">
    <div class="mb-12 text-center">
      <h1 class="mb-4 text-xl font-bold sm:text-3xl md:text-4xl">Nuestros Cursos</h1>
      <p class="text-base-content/70 text-lg sm:text-xl md:text-2xl">
        Encuentra el curso que buscas y el impulso que necesitas.
      </p>
    </div>

    {
      catalogUnavailable && (
        <div class="alert alert-warning mb-6 shadow-lg" role="alert">
          <Icon name="mdi:alert" size={32} class="text-warning" />
          <div>
            <h3 class="font-bold">No pudimos cargar el catÃ¡logo de cursos</h3>
            <p class="text-sm opacity-90">
              El servicio puede estar temporalmente no disponible. Por favor, intenta de nuevo en
              unos minutos.
            </p>
          </div>
        </div>
      )
    }

    {
      !catalogUnavailable && (
        <>
          <div class="flex flex-col gap-6 py-8 lg:flex-row lg:gap-8">
            <aside class="hidden w-full lg:block lg:w-1/3 lg:shrink-0">
              <div class="lg:sticky lg:top-[4.5rem]">
                <CourseFilters departments={departments} levels={levels} courses={sortedCourses} />
              </div>
            </aside>
            <div class="w-full min-w-0 lg:flex-1">
              <label
                for="filters-drawer"
                class="btn btn-primary btn-outline mb-4 gap-2 lg:hidden"
                aria-label="Abrir filtros"
              >
                <Icon name="mdi:filter-variant" size={24} />
                Filtros
                <span
                  id="mobile-filters-badge"
                  class="badge badge-primary badge-sm hidden"
                  aria-hidden="true"
                >
                  0
                </span>
              </label>
              <div class="min-h-[400px]">
                <div
                  id="course-grid"
                  class="grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-3"
                  data-usal="split-item split-fade-u split-delay-400 duration-500"
                >
                  {sortedCourses.map((course) => (
                    <CourseCard course={course} />
                  ))}
                </div>
                <div id="empty-state" class="hidden py-12 text-center">
                  <div class="mb-4 text-6xl">ðŸ“š</div>
                  <h3 class="text-base-content mb-2 text-2xl font-bold">
                    No se encontraron cursos
                  </h3>
                  <p class="text-base-content/70 mb-6">
                    Intenta ajustar los filtros para ver mÃ¡s cursos.
                  </p>
                  <button id="clear-filters" class="btn btn-primary">
                    {' '}
                    Limpiar Filtros{' '}
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div class="drawer z-40">
            <input id="filters-drawer" type="checkbox" class="drawer-toggle" />
            <div class="drawer-content" />
            <div class="drawer-side">
              <label for="filters-drawer" aria-label="cerrar filtros" class="drawer-overlay" />
              <div class="bg-base-200 flex min-h-full w-72 flex-col p-4 sm:w-80 sm:p-6">
                <div class="mb-4 flex items-center justify-between">
                  <span class="text-lg font-semibold">Filtros</span>
                  <label
                    for="filters-drawer"
                    class="btn btn-ghost btn-sm btn-square"
                    aria-label="cerrar"
                  >
                    <Icon name="mdi:close" size={24} />
                  </label>
                </div>
                <CourseFilters
                  departments={departments}
                  levels={levels}
                  courses={sortedCourses}
                  idPrefix="drawer-"
                />
              </div>
            </div>
          </div>
        </>
      )
    }

    <div role="alert" class="alert my-8 shadow-lg">
      <Icon name="mdi:message-alert" size={32} class="text-neutral" />
      <span> Â¿No encuentras el curso que necesitas?</span>
      <div>
        <a
          href="https://wa.me/56934476377?text=Hola%2C%20no%20encuentro%20el%20curso%20que%20necesito.%20%C2%BFMe%20pueden%20ayudar%3F"
          target="_blank"
          rel="noopener noreferrer"
          class="btn btn-sm btn-neutral"
        >
          AvÃ­sanos
        </a>
      </div>
    </div>
  </div>
</Layout>
